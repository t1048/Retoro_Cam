<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Y2K „Éá„Ç∏„Ç´„É°Â§âÊèõÊ©ü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            overscroll-behavior: none;
        }

        /* 2000Âπ¥‰ª£È¢®„ÅÆLCDÁîªÈù¢„Å£„ÅΩ„ÅÑËµ∞ÊüªÁ∑ö */
        .preview-container {
            position: relative;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 100%); /* Vignette effect */
            border: 2px solid #444;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            overflow: hidden;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .scanlines::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.25) 100%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 10;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* „É¨„Éà„É≠„Å™„Éú„Çø„É≥ */
        .retro-btn {
            background: linear-gradient(to bottom, #e0e0e0 0%, #bdbdbd 100%);
            border: 2px solid #888;
            border-bottom-color: #444;
            border-right-color: #444;
            color: #000;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: active 0.1s;
        }
        .retro-btn:active {
            border: 2px solid #444;
            border-bottom-color: #888;
            border-right-color: #888;
            transform: translate(1px, 1px);
        }

        /* „Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #00ff9d;
            border: 2px solid #fff;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 0 5px #00ff9d;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #555;
            border-radius: 2px;
        }

        .timestamp {
            font-family: 'Press Start 2P', cursive;
        }

        .vignette {
            background: radial-gradient(circle, transparent 0%, rgba(0, 0, 0, 0) 70%, rgba(0, 0, 0, 1) 100%);
            opacity: 0;
        }

        .fringing {
            filter: hue-rotate(0deg);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4 pb-20">

    <!-- Header -->
    <header class="w-full max-w-md mb-6 text-center">
        <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-cyan-500" style="font-family: 'VT323', monospace;">
            DIGICAM 2003
        </h1>
        <p class="text-xs text-gray-400 mt-1">Lo-Fi Image Converter</p>
    </header>

    <!-- Main Interface -->
    <main class="w-full max-w-md space-y-6">

        <!-- File Input Area -->
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 shadow-lg">
            <label class="block w-full cursor-pointer">
                <div class="retro-btn w-full py-3 text-center rounded text-sm flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    ÂÜôÁúü„ÇíÈÅ∏Êäû (Select Photo)
                </div>
                <input type="file" id="imageInput" accept="image/*" class="hidden">
            </label>
        </div>

        <!-- Preview Area -->
        <div id="previewArea" class="hidden">
            <div class="preview-container scanlines rounded-lg relative">
                <img id="resultImage" class="max-w-full h-auto object-contain" alt="Converted Image" />
                <div id="loading" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 hidden z-20">
                    <span class="text-green-400 font-mono animate-pulse">PROCESSING...</span>
                </div>
            </div>
            
            <p class="text-center text-xs text-gray-500 mt-2">
                ÁîªÂÉè„ÇíÈï∑Êäº„Åó„Åß‰øùÂ≠ò„ÄÅ„Åæ„Åü„ÅØ‰∏ã„ÅÆ„Éú„Çø„É≥„Çí‰ΩøÁî®
            </p>

            <!-- Controls -->
            <div class="mt-6 bg-gray-800 p-4 rounded-lg border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-green-400 font-mono text-sm">SETTINGS</h3>
                    <span id="dateDisplay" class="text-xs text-orange-400 font-mono"></span>
                </div>

                <div class="space-y-4">
                    <!-- Date Stamp Toggle -->
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-300">Date Stamp</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="dateToggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                        </label>
                    </div>

                    <!-- Custom Timestamp -->
                    <div>
                        <label for="dateInput" class="text-xs text-gray-400 block mb-1">Timestamp Text</label>
                        <input id="dateInput" type="text" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-orange-300 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 placeholder:text-gray-500" placeholder="'03 01 01 00:00">
                        <p class="text-[10px] text-gray-500 mt-1">‰æã: '03 08 21 21:15</p>
                    </div>

                    <!-- Noise Level -->
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Noise (ISO)</span>
                            <span class="text-gray-400">High</span>
                        </div>
                        <input type="range" id="noiseRange" min="0" max="100" value="40">
                    </div>

                    <!-- Flash Level -->
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Flash Glow</span>
                            <span class="text-gray-400">Max</span>
                        </div>
                        <input type="range" id="flashRange" min="0" max="100" value="30">
                    </div>

                    <!-- Vignette -->
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Vignette</span>
                            <span class="text-gray-400">Max</span>
                        </div>
                        <input type="range" id="vignetteRange" min="0" max="100" value="0">
                    </div>

                    <!-- Chromatic Aberration -->
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Fringing</span>
                            <span class="text-gray-400">Max</span>
                        </div>
                        <input type="range" id="aberrationRange" min="0" max="100" value="0">
                    </div>
                </div>
                
                <button id="updateBtn" class="mt-4 w-full py-2 bg-gray-700 hover:bg-gray-600 text-green-400 font-mono text-sm border border-gray-600 rounded">
                    ‚Ü∫ REFRESH EFFECT
                </button>
            </div>

            <!-- Presets -->
            <div class="mt-4 bg-gray-800 p-4 rounded-lg border border-gray-700">
                <h3 class="text-green-400 font-mono text-sm mb-4">PRESETS</h3>
                <div class="space-y-3">
                    <div class="flex gap-2">
                        <input id="presetNameInput" type="text" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Preset Name">
                        <button id="savePresetBtn" class="w-28 text-center retro-btn rounded text-xs px-2 py-2">üíæ Save</button>
                    </div>
                    <div class="flex gap-2">
                        <select id="presetSelect" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">-- Load Preset --</option>
                        </select>
                        <button id="deletePresetBtn" class="w-28 text-center retro-btn rounded text-xs px-2 py-2 bg-red-400">üóëÔ∏è Delete</button>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-3 mt-6">
                <button id="downloadBtn" class="retro-btn py-3 rounded flex flex-col items-center justify-center">
                    <span class="text-lg">üíæ</span>
                    <span class="text-xs mt-1">‰øùÂ≠ò (Save)</span>
                </button>
                <button id="copyBtn" class="retro-btn py-3 rounded flex flex-col items-center justify-center">
                    <span class="text-lg">üìã</span>
                    <span class="text-xs mt-1">„Ç≥„Éî„Éº (Copy)</span>
                </button>
            </div>
            
            <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-black px-4 py-2 rounded shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none z-50 font-bold text-sm">
                Copied!
            </div>
        </div>

    </main>
    
    <!-- Hidden Canvas for Processing -->
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const imageInput = document.getElementById('imageInput');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const resultImage = document.getElementById('resultImage');
        const previewArea = document.getElementById('previewArea');
        const downloadBtn = document.getElementById('downloadBtn');
        const copyBtn = document.getElementById('copyBtn');
        const loading = document.getElementById('loading');
        const toast = document.getElementById('toast');
        const updateBtn = document.getElementById('updateBtn');
        const dateDisplay = document.getElementById('dateDisplay');
        const dateInput = document.getElementById('dateInput');

        // Settings
        const dateToggle = document.getElementById('dateToggle');
        const noiseRange = document.getElementById('noiseRange');
        const flashRange = document.getElementById('flashRange');
        const vignetteRange = document.getElementById('vignetteRange');
        const aberrationRange = document.getElementById('aberrationRange');

        // Preset Elements
        const presetNameInput = document.getElementById('presetNameInput');
        const savePresetBtn = document.getElementById('savePresetBtn');
        const presetSelect = document.getElementById('presetSelect');
        const deletePresetBtn = document.getElementById('deletePresetBtn');

        let originalImage = null;

        // --- Preset Logic ---

        function getPresets() {
            try {
                const presets = localStorage.getItem('y2kPresets');
                return presets ? JSON.parse(presets) : {};
            } catch (e) {
                console.error("Could not parse presets from localStorage", e);
                return {};
            }
        }

        function savePresets(presets) {
            localStorage.setItem('y2kPresets', JSON.stringify(presets));
        }

        function updatePresetList() {
            const presets = getPresets();
            const currentVal = presetSelect.value;
            
            presetSelect.innerHTML = '<option value="">-- Load Preset --</option>'; // Clear existing
            
            for (const name in presets) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                presetSelect.appendChild(option);
            }
            presetSelect.value = currentVal; // Restore selection if it still exists
        }

        function handleSavePreset() {
            const name = presetNameInput.value.trim();
            if (!name) {
                alert("Please enter a name for the preset.");
                return;
            }

            const settings = {
                noise: noiseRange.value,
                flash: flashRange.value,
                vignette: vignetteRange.value,
                aberration: aberrationRange.value
            };

            const presets = getPresets();
            presets[name] = settings;
            savePresets(presets);
            
            updatePresetList();
            presetSelect.value = name; // Select the newly saved preset
            presetNameInput.value = ''; // Clear input
            showToast(`Preset '${name}' saved!`);
        }

        function handleLoadPreset() {
            const name = presetSelect.value;
            if (!name) return;

            const presets = getPresets();
            const settings = presets[name];

            if (settings) {
                noiseRange.value = settings.noise;
                flashRange.value = settings.flash;
                vignetteRange.value = settings.vignette;
                aberrationRange.value = settings.aberration;
                
                // Trigger image processing
                processImage(originalImage);
                showToast(`Preset '${name}' loaded.`);
            }
        }

        function handleDeletePreset() {
            const name = presetSelect.value;
            if (!name) {
                alert("Select a preset to delete.");
                return;
            }

            if (confirm(`Are you sure you want to delete the preset '${name}'?`)) {
                const presets = getPresets();
                delete presets[name];
                savePresets(presets);
                updatePresetList();
                showToast(`Preset '${name}' deleted.`);
            }
        }

        // --- End Preset Logic ---


        // Date Setup
        const defaultDateStamp = getCurrentDateStamp();
        dateInput.value = defaultDateStamp;
        updateDateDisplay();

        function getCurrentDateStamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `'${year.toString().slice(-2)} ${month} ${day}`; // '23 12 09 Style
        }

        function getDateStamp() {
            const text = dateInput.value.trim();
            return text || defaultDateStamp;
        }

        function updateDateDisplay() {
            dateDisplay.innerText = getDateStamp();
        }

        // Initial Event Listeners
        document.addEventListener('DOMContentLoaded', updatePresetList);
        imageInput.addEventListener('change', handleImageUpload);
        updateBtn.addEventListener('click', () => processImage(originalImage));
        
        // Settings Listeners
        noiseRange.addEventListener('input', () => processImage(originalImage));
        flashRange.addEventListener('input', () => processImage(originalImage));
        vignetteRange.addEventListener('input', () => processImage(originalImage));
        aberrationRange.addEventListener('input', () => processImage(originalImage));
        dateToggle.addEventListener('change', () => processImage(originalImage));
        dateInput.addEventListener('input', () => {
            updateDateDisplay();
            processImage(originalImage);
        });

        // Preset Listeners
        savePresetBtn.addEventListener('click', handleSavePreset);
        presetSelect.addEventListener('change', handleLoadPreset);
        deletePresetBtn.addEventListener('click', handleDeletePreset);


        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            loading.classList.remove('hidden');
            previewArea.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    processImage(img);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function processImage(img) {
            if (!img) return;
            loading.classList.remove('hidden');

            // Use setTimeout to allow UI to update (show loading) before heavy processing
            setTimeout(() => {
                // 1. Resize Logic (Simulate low megapixel & optimize performance)
                const maxDimension = 1024; // 2000s cameras were often 1-3MP (1280x960 etc). 1024 is good balance.
                let width = img.width;
                let height = img.height;

                if (width > maxDimension || height > maxDimension) {
                    if (width > height) {
                        height = Math.round((height * maxDimension) / width);
                        width = maxDimension;
                    } else {
                        width = Math.round((width * maxDimension) / height);
                        height = maxDimension;
                    }
                }

                canvas.width = width;
                canvas.height = height;

                // Draw original resized
                ctx.drawImage(img, 0, 0, width, height);
                
                // Get Settings
                const noiseAmount = parseInt(noiseRange.value);
                const flashAmount = parseInt(flashRange.value);
                const vignetteAmount = parseInt(vignetteRange.value);
                const aberrationAmount = parseInt(aberrationRange.value) / 1000; // smaller, more controllable shift

                // Get pixel data
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                const originalData = new Uint8ClampedArray(data); // Copy for sampling

                // 2. Pixel Manipulation
                for (let i = 0; i < data.length; i += 4) {
                    let r = data[i];
                    let g = data[i + 1];
                    let b = data[i + 2];

                    // Digicam Green Shift (old sensors often leaned green/cyan)
                    g = g * 1.02; 
                    b = b * 1.02;

                    // Noise
                    if (noiseAmount > 0) {
                        const noise = (Math.random() - 0.5) * noiseAmount;
                        r += noise;
                        g += noise;
                        b += noise;
                    }

                    // Contrast boost (cheap lens look)
                    const factor = 1.1; // Contrast level
                    const intercept = 128 * (1 - factor);
                    r = r * factor + intercept;
                    g = g * factor + intercept;
                    b = b * factor + intercept;

                    data[i] = r;
                    data[i + 1] = g;
                    data[i + 2] = b;
                }
                
                // 3. Chromatic Aberration
                if (aberrationAmount > 0) {
                    for (let i = 0; i < data.length; i += 4) {
                        const x = (i / 4) % width;
                        const y = Math.floor((i / 4) / width);
                        
                        const dx = x - width / 2;
                        const dy = y - height / 2;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        const shift = dist * aberrationAmount;

                        const r_index = (Math.round(x - shift) + Math.round(y) * width) * 4;
                        const b_index = (Math.round(x + shift) + Math.round(y) * width) * 4;

                        if (r_index >= 0 && r_index < data.length) {
                           data[i] = originalData[r_index];
                        }
                        if (b_index >= 0 && b_index < data.length) {
                           data[i+2] = originalData[b_index];
                        }
                    }
                }

                ctx.putImageData(imageData, 0, 0);
                
                // 4. Simulated Flash (Center Glow)
                if (flashAmount > 0) {
                    ctx.globalCompositeOperation = 'screen';
                    const gradient = ctx.createRadialGradient(width/2, height/2, width/10, width/2, height/2, width * 0.8);
                    
                    const flashOpacity = flashAmount / 200; // 0 to 0.5
                    gradient.addColorStop(0, `rgba(255, 255, 220, ${flashOpacity})`);
                    gradient.addColorStop(1, `rgba(0, 0, 0, 0)`);

                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, width, height);
                    ctx.globalCompositeOperation = 'source-over'; // Reset
                }

                // 5. Vignette (Darken Edges)
                if (vignetteAmount > 0) {
                    const gradient = ctx.createRadialGradient(width/2, height/2, width/2, width/2, height/2, width * 0.2);
                    
                    const vignetteOpacity = vignetteAmount / 100; // 0 to 1
                    gradient.addColorStop(0, `rgba(0, 0, 0, 0)`);
                    gradient.addColorStop(1, `rgba(0, 0, 0, ${vignetteOpacity})`);

                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, width, height);
                }
                
                // 6. Date Stamp
                if (dateToggle.checked) {
                    // Font size relative to image height
                    const fontSize = Math.floor(height * 0.05); 
                    ctx.font = `bold ${fontSize}px "Courier New", Courier, monospace`;
                    const dateStr = getDateStamp();
                    
                    const marginX = width * 0.05;
                    const marginY = height * 0.05;

                    // Digital Orange Color
                    ctx.fillStyle = "#ffaa00"; 
                    
                    // Add a slight glow/shadow to text to make it readable
                    ctx.shadowColor = "rgba(0,0,0,0.8)";
                    ctx.shadowBlur = 4;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;
                    
                    ctx.textAlign = "right";
                    ctx.fillText(dateStr, width - marginX, height - marginY);

                    // Reset shadow
                    ctx.shadowColor = "transparent";
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                }

                // Output
                const resultDataUrl = canvas.toDataURL('image/jpeg', 0.85); // JPEG artifacts help the look!
                resultImage.src = resultDataUrl;
                
                loading.classList.add('hidden');
            }, 50);
        }

        // Save Function
        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `y2k_photo_${Date.now()}.jpg`;
            link.href = resultImage.src;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü");
        });

        // Copy Function
        copyBtn.addEventListener('click', async () => {
            try {
                // Fetch the DataURL as a blob
                const response = await fetch(resultImage.src);
                const blob = await response.blob();
                
                // Clipboard API requires standard Blob logic
                const item = new ClipboardItem({ "image/png": blob }); // Most browsers prefer png for clipboard
                await navigator.clipboard.write([item]);
                showToast("„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ");
            } catch (err) {
                console.error(err);
                // Fallback for security restrictions or unsupported browsers
                showToast("ÁîªÂÉè„ÇíÈï∑Êäº„Åó„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            }
        });

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2000);
        }

    </script>
</body>
</html>
